<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance.ai Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --blue:#1d4ed8;--bg:#f5f7fb;--card:#fff;
  --muted:#64748b;--red:#ef4444;--green:#22c55e
}
*{box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{margin:0;background:var(--bg)}
.app{display:flex;height:100vh}

.sidebar{
  width:230px;background:#fff;padding:20px;
  display:flex;flex-direction:column;border-right:1px solid #e5e7eb
}
.logo{font-weight:700;color:var(--blue);margin-bottom:30px}
.user{margin-top:auto;background:#f1f5f9;padding:12px;border-radius:10px}

.main{flex:1;padding:20px;overflow-y:auto}
.topbar{display:flex;justify-content:space-between;align-items:center}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:20px}
.card{background:#fff;padding:20px;border-radius:16px}

.circle{
  width:90px;height:90px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;color:var(--blue)
}

.progress{height:6px;background:#e5e7eb;border-radius:10px}
.progress span{display:block;height:100%}

.alert{padding:10px;border-radius:10px;margin-top:10px}
.bad{background:#fee2e2}
.good{background:#ecfeff}

button{
  background:var(--blue);color:#fff;border:none;
  padding:10px 14px;border-radius:8px;cursor:pointer
}
.small{font-size:12px;color:var(--muted)}
/* ===== SIDEBAR (ADDED) ===== */
.sidebar{
  width:240px;
  background:#fff;
  padding:20px 16px;
  border-right:1px solid #e5e7eb;
  display:flex;
  flex-direction:column;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:700;
  color:var(--blue);
  margin-bottom:30px;
}

.brand-icon{
  width:36px;
  height:36px;
  border-radius:10px;
  background:var(--blue);
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
}

/* ===== NAVBAR ===== */
.nav{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.nav a{
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 14px;
  border-radius:12px;
  color:var(--muted);
  font-weight:500;
  cursor:pointer;
  text-decoration:none;
  transition:0.2s;
}

.nav a.active{
  background:var(--light-blue);
  color:var(--blue);
}

.nav a:hover{
  background:#f1f5f9;
}

</style>
</head>

<body>

<div class="app">

<aside class="sidebar">
  <div class="logo">Turnout Tracker</div>
    <nav class="nav">
      <a class="active">Dashboard</a>
      <a>Schedule</a>
      <a>Reports</a>
      <a>Security</a>
      <a>Settings</a>
    </nav>
  <div class="user">
    <strong id="userName"></strong><br>
    <span id="userId"></span>
  </div>
  </aside>

<main class="main">
  <div class="topbar">
    <h2 id="greeting"></h2>
    <span class="small" id="session"></span>
  </div>

  <!-- KPIs -->
  <div class="cards">
    <div class="card">
      <div class="circle" id="overall"></div>
      <strong>Overall Attendance</strong>
      <div class="small" id="status"></div>
    </div>

    <div class="card">
      <strong>Risk Analysis</strong>
      <p id="risk"></p>
    </div>

    <div class="card">
      <strong>Best Subject</strong>
      <p id="best"></p>
    </div>
  </div>

  <!-- SUBJECTS -->
  <div class="card" style="margin-top:20px">
    <strong>Subjects</strong>
    <div id="subjects"></div>
    <br>
    <button onclick="markAttendance()">Mark Attendance</button>
  </div>

  <!-- ALERTS -->
  <div class="card" style="margin-top:20px">
    <strong>Live Alerts</strong>
    <div id="alerts"></div>
  </div>
</main>

</div>

<script>
/* ================= API CALLS ================= */

async function api(url, options={}){
  const res = await fetch(url, {
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    ...options
  });
  return res.json();
}

/* ================= LOAD DASHBOARD ================= */

async function loadDashboard(){
  const user = await api("/api/auth/me");
  userName.textContent = user.name;
  userId.textContent = user.studentId;
  greeting.textContent = `Good morning, ${user.name}`;

  const summary = await api("/api/attendance/summary");
  const subjects = await api("/api/attendance/subjects");

  renderSummary(summary);
  renderSubjects(subjects);
  renderAlerts(summary, subjects);
}

/* ================= RENDER ================= */

function renderSummary(d){
  overall.textContent = d.overall + "%";
  overall.style.background =
    `conic-gradient(var(--blue) 0% ${d.overall}%, #e5e7eb ${d.overall}% 100%)`;

  status.textContent = d.overall >= 75 ? "Safe" : "At Risk";
  risk.textContent = d.overall >= 75
    ? "No immediate risk"
    : "Below mandatory attendance";

  best.textContent = d.bestSubject;
}

function renderSubjects(list){
  subjects.innerHTML = "";
  list.forEach(s=>{
    subjects.innerHTML += `
      <p>
        <strong>${s.name}</strong> – ${s.percent}%
        <div class="progress">
          <span style="width:${s.percent}%;
            background:${s.percent>=75?'var(--blue)':'var(--red)'}"></span>
        </div>
      </p>`;
  });
}

function renderAlerts(summary){
  alerts.innerHTML = "";
  if(summary.overall < 75)
    alerts.innerHTML += `<div class="alert bad">⚠️ Attendance below 75%</div>`;
  if(summary.overall >= 90)
    alerts.innerHTML += `<div class="alert good">✅ Excellent consistency</div>`;
}

/* ================= ACTION ================= */

async function markAttendance(){
  await api("/api/attendance/mark", { method:"POST" });
  loadDashboard(); // refresh live
}

/* ================= LIVE UPDATE (OPTIONAL) ================= */

// If you have WebSocket
/*
const socket = new WebSocket("wss://yourdomain/api/attendance/stream");
socket.onmessage = () => loadDashboard();
*/

/* ================= START ================= */

loadDashboard();
setInterval(loadDashboard, 30000); // auto refresh every 30s
</script>

</body>

</html>
